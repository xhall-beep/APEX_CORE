name: DroidMind CI/CD ğŸŒŒ

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-test: # ğŸ—ï¸ Build, Lint & Test ğŸ§ª
    name: ğŸ—ï¸ Build, Lint & Test ğŸ§ª
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for `softprops/action-gh-release` to generate release notes

      - name: ğŸ Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache-dependency-path: "pyproject.toml"

      - name: âš¡ Install uv Build System
        uses: astral-sh/setup-uv@v6

      - name: ğŸ“¦ Install Project Dependencies
        run: uv sync --all-groups

      - name: ğŸ’… Run DroidMind Lint Script
        run: uv run python scripts/lint.py

      - name: ğŸ§ª Execute Pytest Suite
        run: uv run pytest

      - name: ğŸ“„ Upload Test Results Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: test-results/ # Adjust if your pytest output path is different

      - name: ğŸ§ Set up QEMU (for multi-platform builds)
        uses: docker/setup-qemu-action@v3

      - name: ğŸ› ï¸ Set up Docker Buildx Engine
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build Docker Image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: droidmind:latest,droidmind:${{ github.sha }}

  build-docs: # ğŸ“š Build Documentation Site ğŸŒ
    name: ğŸ“š Build Documentation Site ğŸŒ
    needs: [build-and-test]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache-dependency-path: "pyproject.toml"

      - name: âš¡ Install uv Build System
        uses: astral-sh/setup-uv@v6

      - name: ğŸ“– Install Documentation Dependencies
        run: uv sync --all-groups

      - name: ğŸ—ï¸ Build MkDocs Site
        run: uv run mkdocs build --config-file mkdocs.yml

      - name: ğŸ“¤ Upload Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-${{ github.sha }}
          path: site

  deploy-docs: # ğŸš€ Deploy Documentation to GitHub Pages ğŸ“„
    name: ğŸš€ Deploy Documentation to GitHub Pages ğŸ“„
    needs: [build-docs]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Built Documentation Artifact
        uses: actions/download-artifact@v4
        with:
          name: site-${{ github.sha }}
          path: site

      - name: ğŸŒ Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

  create-release: # ğŸ‰ Create GitHub Release âœ¨
    name: ğŸ‰ Create GitHub Release âœ¨
    needs: [build-and-test, deploy-docs]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: ğŸ›°ï¸ Checkout Repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for release notes generation

      - name: ğŸ·ï¸ Generate GitHub Release Notes
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          # files: | # Optional: attach files like .whl or .tar.gz to the release
          #   dist/*.whl
          #   dist/*.tar.gz

  publish-pypi: # ğŸ Publish Python Package to PyPI ğŸ“¦
    name: ğŸ Publish Python Package to PyPI ğŸ“¦
    needs: create-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      id-token: write # For trusted PyPI publishing
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: âš¡ Install uv Build System
        uses: astral-sh/setup-uv@v6

      - name: ğŸ› ï¸ Build Python Package
        run: |
          uv pip install --system build
          python -m build

      - name: ğŸš€ Publish to PyPI via Trusted Publisher
        uses: pypa/gh-action-pypi-publish@release/v1

  publish-docker: # ğŸ³ Publish Docker Image to Registries ğŸš¢
    name: ğŸ³ Publish Docker Image to Registries ğŸš¢
    needs: create-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      packages: write
      id-token: write # If using OIDC for Docker Hub
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”– Extract Version from Git Tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: ğŸ§ Set up QEMU (for multi-platform builds)
        uses: docker/setup-qemu-action@v3

      - name: ğŸ› ï¸ Set up Docker Buildx Engine
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ” Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Build & Push Docker Images to Registries
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            hyperb1iss/droidmind:latest
            hyperb1iss/droidmind:${{ steps.get_version.outputs.VERSION }}
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }}
          labels: |
            org.opencontainers.image.title=DroidMind
            org.opencontainers.image.description=Control Android devices with AI through the Model Context Protocol
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.version=${{ steps.get_version.outputs.VERSION }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}
            org.opencontainers.image.revision=${{ github.sha }}
